const TelegramBot = require("node-telegram-bot-api");
const express = require("express");

const bot = new TelegramBot("8043984408:AAGJxqVdQv67fTDKobKE1axIMrtG6grDYVM", {
  polling: {
    interval: 300,
    autoStart: true,
    params: {
      timeout: 10,
    },
  },
});

// Handle polling errors
bot.on("polling_error", (error) => {
  console.log("Polling error:", error.message);
});

// Delete webhook if exists to avoid conflicts
bot
  .deleteWebHook()
  .then(() => {
    console.log("Webhook deleted successfully");
  })
  .catch((err) => {
    console.log("No webhook to delete or error:", err.message);
  });
const adminChatId = -4972889819;
const userState = {};
const channelUsername = "@hayoti_tajribam";
const commands = [
  {
    command: "start",
    description: "Botni Ishga Tushurish",
  },
  {
    command: "menyu",
    description: "Asosi menyuni ochish",
  },
  {
    command: "help",
    description: "Yordam",
  },
];

bot.setMyCommands(commands);

function escapeMarkdown(text) {
  return text.replace(/([_*[\]()~`>#+\-=|{}.!])/g, "\\$1");
}

function sendMainMenu(chatId) {
  bot.sendMessage(
    chatId,
    "ğŸ  <b>Bosh menyu</b>\n\nQuyidagi xizmatlardan birini tanlang:",
    {
      parse_mode: "HTML",
      reply_markup: {
        keyboard: [
          ["ğŸŒ Web-sayt", "ğŸ”‘ Domen & Hosting"],
          ["ğŸ¤– Bot xizmatlari", "ğŸ“¦ Buyurtma berish"],
          ["ğŸ§¤ Innovatsion buyum", "ğŸ‘¨â€ğŸ’¼ Admin"],
          ["âŒ Menyuni yopish"],
        ],
        resize_keyboard: true,
      },
    },
  );
}

bot.onText(/\/menyu/, (msg) => {
  const chatId = msg.chat.id;
  sendMainMenu(chatId);
});

bot.onText(/\/help/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(
    chatId,
    "ğŸ¤– <b>Yordam</b>\n\n" +
      "/start - Botni ishga tushirish\n" +
      "/menyu - Asosiy menyuni ochish\n" +
      "/help - Ushbu yordam xabarini ko'rsatish\n\n" +
      "Savollar uchun: @KXNexsus",
    { parse_mode: "HTML" },
  );
});

bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  userState[chatId] = { step: 0, serviceType: null };

  try {
    const res = await bot.getChatMember(channelUsername, userId);
    if (!["member", "administrator", "creator"].includes(res.status)) {
      return bot.sendMessage(
        chatId,
        `Iltimos, quyidagi kanalga obuna bo'ling: ${channelUsername}`,
        {
          reply_markup: {
            inline_keyboard: [
              [
                {
                  text: "ğŸ”— Kanalga o'tish",
                  url: `https://t.me/${channelUsername.replace("@", "")}`,
                },
              ],
              [
                {
                  text: "âœ… Obuna bo'ldim",
                  callback_data: "check_subscription",
                },
              ],
            ],
          },
        },
      );
    }
  } catch (err) {
    console.error(err);
    return bot.sendMessage(
      chatId,
      "â— Bot kanalga admin bo'lishi kerak yoki kanal topilmadi.",
    );
  }

  sendMainMenu(chatId);
});

bot.on("callback_query", async (query) => {
  const chatId = query.message.chat.id;
  const data = query.data;
  const userId = query.from.id;

  bot.answerCallbackQuery(query.id);
  if (!userState[chatId]) userState[chatId] = {};

  switch (data) {
    case "check_subscription":
      try {
        const res = await bot.getChatMember(channelUsername, userId);
        if (["member", "administrator", "creator"].includes(res.status)) {
          sendMainMenu(chatId);
        } else {
          return bot.sendMessage(chatId, "âŒ Hali ham obuna bo'lmagansiz.");
        }
      } catch (err) {
        return bot.sendMessage(
          chatId,
          "â— Obuna tekshiruvda xatolik yuz berdi.",
        );
      }
      break;

    case "start_menu":
      userState[chatId] = { step: 0, serviceType: null };
      sendMainMenu(chatId);
      break;

    case "order_0dan":
    case "order_clone":
    case "order_update":
    case "Domain_buyurtma":
    case "Bot_buyurtma":
    case "deflaut_buyurtma":
      userState[chatId].serviceType = data;
      userState[chatId].step = 1;
      bot.sendMessage(chatId, "ğŸ“ Iltimos, ismingizni kiriting:", {
        reply_markup: {
          keyboard: [["ğŸ”™ Ortga"]],
          resize_keyboard: true,
        },
      });
      break;

    case "domain_hosting":
      bot.sendMessage(
        chatId,
        "ğŸ”‘ <b>Domen va Hosting:</b>\n\nğŸŒ Domen ro'yxatga olish\nğŸš€ Hostingga ulash\nğŸ Tayyor domenlar\nğŸ’² Narx: 5$ - 50$",
        {
          parse_mode: "HTML",
          reply_markup: {
            keyboard: [
              [
                {
                  text: "Tayyor Domenlar",
                  url: "https://t.me/KXNexsusTayyorDomenlar",
                },
              ],
              [
                {
                  text: "ğŸ“¥ Buyurtma berish",
                  callback_data: "Domain_buyurtma",
                },
              ],
              [{ text: "ğŸ”™ Ortga", callback_data: "start_menu" }],
            ],
          },
        },
      );
      break;

    case "bot":
      bot.sendMessage(
        chatId,
        "ğŸ¤– <b>Bot xizmatlari:</b>\nğŸ’¬ Telegram botlar\nğŸ“¡ Avtojavoblar\nğŸ”— Sayt bilan bog'lash\nğŸ’² Narx: 5$ - 50$",
        {
          parse_mode: "HTML",
          reply_markup: {
            keyboard: [
              [
                {
                  text: "ğŸŒ Tayyor Botlar",
                  web_app: {
                    url: "https://chatgpt.com/",
                  },
                },
              ],
              ["ğŸ“¥ Buyurtma berish"],
              ["ğŸ”™ Ortga"],
            ],
          },
        },
      );
      break;

    case "admin":
      bot.sendMessage(
        chatId,
        "<b>Admin bilan bog'lanish:</b>\n@KXNexsus\n\n<i>Bot haqida fikr-mulohaza:</i>\n@M_Kimyonazarov",
        {
          parse_mode: "HTML",
          reply_markup: {
            keyboard: [[{ text: "ğŸ”™ Ortga", callback_data: "start_menu" }]],
          },
        },
      );
      break;

    case "buyum":
      bot.sendMessage(
        chatId,
        "ğŸ§¤ <b>Innovatsion buyum:</b>\nğŸ™ Soqovlar uchun imo-ni nutqqa aylantiruvchi qo'lqop\n\nğŸ“½ <a href='https://drive.google.com/file/d/1-5uau7c7YabLrJ9Beo5cO1-QNb6jmskt/view?usp=drivesdk'>Video bilan tanishing</a>",
        {
          parse_mode: "HTML",
          disable_web_page_preview: true,
          reply_markup: {
            keyboard: [[{ text: "ğŸ”™ Ortga", callback_data: "start_menu" }]],
          },
        },
      );
      break;

    default:
      bot.sendMessage(chatId, "âš ï¸ Noma'lum buyruq.", {
        reply_markup: {
          keyboard: [[{ text: "ğŸ”™ Ortga", callback_data: "start_menu" }]],
        },
      });
  }
});

bot.on("message", (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;

  // Skip commands
  if (text.startsWith("/")) return;

  // Handle main menu keyboard buttons
  if (!userState[chatId] || userState[chatId].step === 0) {
    switch (text) {
      case "ğŸŒ Web-sayt":
        bot.sendMessage(
          chatId,
          "ğŸŒ <b>Web-sayt xizmatlari:</b>\n\nQuyidagi variantlardan birini tanlang:",
          {
            parse_mode: "HTML",
            reply_markup: {
              keyboard: [
                ["ğŸŒ 0 dan yasash", "ğŸ“¥ Template dan ko'chirish"],
                ["ğŸ›  Yangilash"],
                ["ğŸ”™ Ortga"],
              ],
              resize_keyboard: true,
            },
          },
        );
        return;

      case "ğŸ”‘ Domen & Hosting":
        bot.sendMessage(
          chatId,
          "ğŸ”‘ <b>Domen va Hosting:</b>\n\nğŸŒ Domen ro'yxatga olish\nğŸš€ Hostingga ulash\nğŸ Tayyor domenlar\nğŸ’² Narx: 5$ - 50$",
          {
            parse_mode: "HTML",
            reply_markup: {
              keyboard: [
                [
                  {
                    text: "ğŸŒ Tayyor Domen",
                    web_app: {
                      url: "https://chatgpt.com/",
                    },
                  },
                ],
                ["ğŸ“¥ Buyurtma berish"],
                ["ğŸ”™ Ortga"],
              ],
              resize_keyboard: true,
              one_time_keyboard: false,
            },
          },
        );
        return;

      case "ğŸ¤– Bot xizmatlari":
        bot.sendMessage(
          chatId,
          "ğŸ¤– <b>Bot xizmatlari:</b>\nğŸ’¬ Telegram botlar\nğŸ“¡ Avtojavoblar\nğŸ”— Sayt bilan bog'lash\nğŸ’² Narx: 5$ - 50$",
          {
            parse_mode: "HTML",
            reply_markup: {
              keyboard: [
                [
                  {
                    text: "ğŸŒ Tayyor Botlar",
                    web_app: {
                      url: "https://chatgpt.com/",
                    },
                  },
                ],
                ["ğŸ“¥ Buyurtma berish"],
                ["ğŸ”™ Ortga"],
              ],
              resize_keyboard: true,
            },
          },
        );
        return;

      case "ğŸ“¦ Buyurtma berish":
        userState[chatId] = { step: 1, serviceType: "deflaut_buyurtma" };
        bot.sendMessage(chatId, "ğŸ“ Iltimos, ismingizni kiriting:", {
          reply_markup: {
            keyboard: [["ğŸ”™ Ortga"]],
            resize_keyboard: true,
          },
        });
        return;

      case "ğŸ§¤ Innovatsion buyum":
        bot.sendMessage(
          chatId,
          "ğŸ§¤ <b>Innovatsion buyum:</b>\nğŸ™ Soqovlar uchun imo-ni nutqqa aylantiruvchi qo'lqop\n\nğŸ“½ <a href='https://drive.google.com/file/d/1-5uau7c7YabLrJ9Beo5cO1-QNb6jmskt/view?usp=drivesdk'>Video bilan tanishing</a>",
          {
            parse_mode: "HTML",
            disable_web_page_preview: true,
            reply_markup: {
              keyboard: [["ğŸ”™ Ortga"]],
              resize_keyboard: true,
            },
          },
        );
        return;

      case "ğŸ‘¨â€ğŸ’¼ Admin":
        bot.sendMessage(
          chatId,
          "<b>Admin bilan bog'lanish:</b>\n@KXNexsus\n\n<i>Bot haqida fikr-mulohaza:</i>\n@M_Kimyonazarov",
          {
            parse_mode: "HTML",
            reply_markup: {
              keyboard: [["ğŸ”™ Ortga"]],
              resize_keyboard: true,
            },
          },
        );
        return;

      case "âŒ Menyuni yopish":
        bot.sendMessage(
          chatId,
          "âœ… Menyu yopildi.\nMenyuni ochish uchun /menyu buyrug'ini yuboring",
          {
            reply_markup: {
              remove_keyboard: true,
            },
          },
        );
        return;

      case "ğŸŒ 0 dan yasash":
        userState[chatId] = { step: 1, serviceType: "order_0dan" };
        bot.sendMessage(chatId, "ğŸ“ Iltimos, ismingizni kiriting:", {
          reply_markup: {
            keyboard: [["ğŸ”™ Ortga"]],
            resize_keyboard: true,
          },
        });
        return;

      case "ğŸ“¥ Template dan ko'chirish":
        userState[chatId] = { step: 1, serviceType: "order_clone" };
        bot.sendMessage(chatId, "ğŸ“ Iltimos, ismingizni kiriting:", {
          reply_markup: {
            keyboard: [["ğŸ”™ Ortga"]],
            resize_keyboard: true,
          },
        });
        return;

      case "ğŸ›  Yangilash":
        userState[chatId] = { step: 1, serviceType: "order_update" };
        bot.sendMessage(chatId, "ğŸ“ Iltimos, ismingizni kiriting:", {
          reply_markup: {
            keyboard: [["ğŸ”™ Ortga"]],
            resize_keyboard: true,
          },
        });
        return;

      case "ğŸ”™ Ortga":
        userState[chatId] = { step: 0, serviceType: null };
        sendMainMenu(chatId);
        return;
    }
  }

  // Handle order process
  if (!userState[chatId]) return;

  const state = userState[chatId];

  // Handle back button during order process
  if (text === "ğŸ”™ Ortga") {
    userState[chatId] = { step: 0, serviceType: null };
    sendMainMenu(chatId);
    return;
  }

  switch (state.step) {
    case 1:
      state.name = text;
      state.step = 2;
      bot.sendMessage(chatId, "ğŸ“ Telefon raqamingizni kiriting:", {
        reply_markup: {
          keyboard: [
            [{ text: "Nomerni Kiritish", request_contact: true }],
            ["ğŸ”™ Ortga"],
          ],
          resize_keyboard: true,
        },
      });
      break;
    case 2:
      state.phone = text;
      state.step = 3;
      bot.sendMessage(
        chatId,
        "ğŸ“ Qo'shimcha izohingiz bo'lsa yozing (yo'q bo'lsa, 'Yo'q' deb yozing):",
        {
          reply_markup: {
            keyboard: [["ğŸ”™ Ortga"]],
            resize_keyboard: true,
          },
        },
      );
      break;
    case 3:
      state.comment = text;
      const user = msg.from;
      let service =
        {
          order_0dan: "0 dan sayt yasabberish",
          order_clone: "Template dan sayt yaratish",
          order_update: "Sayt yangilash",
          Domain_buyurtma: "Domen & Hosting",
          Bot_buyurtma: "Bot xizmatlari",
          deflaut_buyurtma: "Umumiy buyurtma",
        }[state.serviceType] || "Umumiy";
      const summary = `
ğŸ“¥ *Yangi Buyurtma:*
ğŸ‘¤ Buyurtmachi: ${user.first_name || "Noma'lum"}
ğŸ”— Username: ${user.username ? "@" + user.username : "Yo'q"}
ğŸ†” ID: ${user.id}
ğŸ‘¨â€ğŸ’¼ Ismi: ${state.name}
ğŸ“ Tel: ${state.phone}
ğŸ›  Xizmat: ${service}
ğŸ“ Izoh: ${state.comment}`;

      bot.sendMessage(
        chatId,
        "âœ… Buyurtmangiz qabul qilindi! Tez orada bog'lanamiz.",
      );
      bot.sendMessage(adminChatId, escapeMarkdown(summary), {
        parse_mode: "Markdown",
      });
      delete userState[chatId];
      sendMainMenu(chatId);
      break;
  }
});

const app = express();
app.get("/", (req, res) => {
  res.send("ğŸ¤– Bot ishlayapti!");
});
app.listen(3000, () => {
  console.log("âœ… Express server ishga tushdi. Port: 3000");
});
