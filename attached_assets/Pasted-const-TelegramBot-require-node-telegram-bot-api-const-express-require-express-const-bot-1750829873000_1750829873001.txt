const TelegramBot = require("node-telegram-bot-api");
const express = require("express");

const bot = new TelegramBot("8043984408:AAGJxqVdQv67fTDKobKE1axIMrtG6grDYVM", {
  polling: true,
});
const adminChatId = -4972889819;
const userState = {};
const channelUsername = "@hayoti_tajribam";
const commands = [
  {
    command: "start",
    description: "Botni Ishga Tushurish",
  },
  {
    command: "help",
    description: "Yordam",
  },
];

bot.setMyCommands(commands);

function escapeMarkdown(text) {
  return text.replace(/([_*[\]()~`>#+\-=|{}.!])/g, "\\$1");
}

function sendMainMenu(chatId) {
  bot.sendMessage(
    chatId,
    "ğŸ  <b>Bosh menyu</b>\n\nQuyidagi xizmatlardan birini tanlang:",
    {
      parse_mode: "HTML",
      reply_markup: {
        keyboard: [
          ["ğŸŒ Web-sayt", "ğŸ”‘ Domen & Hosting"],
          ["ğŸ¤– Bot xizmatlari", "ğŸ“¦ Buyurtma berish"],
          ["ğŸ§¤ Innovatsion buyum", "ğŸ‘¨â€ğŸ’¼ Admin"],
          ["âŒ Menyuni yopish"]
          // [{ text: "ğŸŒ Web-sayt", callback_data: "website" }],
          // [{ text: "ğŸ”‘ Domen & Hosting", callback_data: "domain_hosting" }],
          // [{ text: "ğŸ¤– Bot xizmatlari", callback_data: "bot" }],
          // [{ text: "ğŸ“¦ Buyurtma berish", callback_data: "deflaut_buyurtma" }],
          // [{ text: "ğŸ§¤ Innovatsion buyum", callback_data: "buyum" }],
          // [{ text: "ğŸ‘¨â€ğŸ’¼ Admin", callback_data: "admin" }],
        ],
          resize_keyboard: true,
      },
    },
  );
}

bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  userState[chatId] = { step: 0, serviceType: null };

  try {
    const res = await bot.getChatMember(channelUsername, userId);
    if (!["member", "administrator", "creator"].includes(res.status)) {
      return bot.sendMessage(
        chatId,
        `Iltimos, quyidagi kanalga obuna boâ€˜ling: ${channelUsername}`,
        {
          reply_markup: {
            keyboard: [
              [ 'ğŸ”— Kanalga oâ€˜tish', 'âœ… Obuna boâ€˜ldim']
              // [
              //   {
              //     text: "ğŸ”— Kanalga o'tish",
              //     url: `https://t.me/${channelUsername.replace("@", "")}`,
              //   },
              // ],
              // [
              //   {
              //     text: "âœ… Obuna boâ€˜ldim",
              //     callback_data: "check_subscription",
              //   },
              // ],
            ],
          },
        },
      );
    }
  } catch (err) {
    console.error(err);
    return bot.sendMessage(
      chatId,
      "â— Bot kanalga admin boâ€˜lishi kerak yoki kanal topilmadi.",
    );
  }

  sendMainMenu(chatId);
});

bot.on("callback_query", async (query) => {
  const chatId = query.message.chat.id;
  const data = query.data;
  const userId = query.from.id;

  bot.answerCallbackQuery(query.id);
  if (!userState[chatId]) userState[chatId] = {};

  switch (data) {
    case "check_subscription":
      try {
        const res = await bot.getChatMember(channelUsername, userId);
        if (["member", "administrator", "creator"].includes(res.status)) {
          return bot.sendMessage(
            chatId,
            "âœ… Rahmat! Siz kanalga obuna boâ€˜lgansiz.",
            {
              reply_markup: {
                keyboard: [
                  ["ğŸ”™ Ortga"],
                ],
              },
            },
          );
        } else {
          return bot.sendMessage(chatId, "âŒ Hali ham obuna boâ€˜lmagansiz.");
        }
      } catch (err) {
        return bot.sendMessage(
          chatId,
          "â— Obuna tekshiruvda xatolik yuz berdi.",
        );
      }

    case "start_menu":
      userState[chatId] = { step: 0, serviceType: null };
      sendMainMenu(chatId);
      break;

    case "deflaut_buyurtma":
      userState[chatId].step = 1;
      bot.sendMessage(chatId, "ğŸ“ Iltimos, ismingizni kiriting:", {
        reply_markup: {
          keyboard: [
            ["ğŸ”™ Ortga"],
          ],
        },
      });
      break;

    case "website":
      bot.sendMessage(chatId, "ğŸŒ <b>Web-sayt xizmatlari:</b> ...", {
        parse_mode: "HTML",
        reply_markup: {
          keyboard: [
            ["ğŸŒ 0 dan yasash", "ğŸ“¥ Template dan ko'chirish"],
            ["ğŸ›  Yangilash"],
            ["ğŸ”™ Ortga"],
            // [{ text: "ğŸŒ 0 dan yasash", callback_data: "order_0dan" }],
            // [
            //   {
            //     text: "ğŸ“¥ Template dan ko'chirish",
            //     callback_data: "order_clone",
            //   },
            // ],
            // [{ text: "ğŸ›  Yangilash", callback_data: "order_update" }],
            // [{ text: "ğŸ”™ Ortga", callback_data: "start_menu" }],
          ],
        },
      });
      break;

    case "order_0dan":
    case "order_clone":
    case "order_update":
    case "Domain_buyurtma":
    case "Bot_buyurtma":
      userState[chatId].serviceType = data;
      userState[chatId].step = 1;
      bot.sendMessage(chatId, "ğŸ“ Iltimos, ismingizni kiriting:", {
        reply_markup: {
          inline_keyboard: [
            [{ text: "ğŸ”™ Ortga", callback_data: "start_menu" }],
          ],
        },
      });
      break;

    case "domain_hosting":
      bot.sendMessage(
        chatId,
        "ğŸ”‘ <b>Domen va Hosting:</b>\n\nğŸŒ Domen roâ€˜yxatga olish\nğŸš€ Hostingga ulash\nğŸ Tayyor domenlar\nğŸ’² Narx: 5$ - 50$",
        {
          parse_mode: "HTML",
          reply_markup: {
            inline_keyboard: [
              [
                {
                  text: "Tayyor Domenlar",
                  url: "https://t.me/KXNexsusTayyorDomenlar",
                },
              ],
              [
                {
                  text: "ğŸ“¥ Buyurtma berish",
                  callback_data: "Domain_buyurtma",
                },
              ],
              [{ text: "ğŸ”™ Ortga", callback_data: "start_menu" }],
            ],
          },
        },
      );
      break;

    case "bot":
      bot.sendMessage(
        chatId,
        "ğŸ¤– <b>Bot xizmatlari:</b>\nğŸ’¬ Telegram botlar\nğŸ“¡ Avtojavoblar\nğŸ”— Sayt bilan bogâ€˜lash\nğŸ’² Narx: 5$ - 50$",
        {
          parse_mode: "HTML",
          reply_markup: {
            inline_keyboard: [
              [
                {
                  text: "Tayyor Botlar",
                  url: "https://t.me/KXNexsusTayyorBotlar",
                },
              ],
              [{ text: "ğŸ“¥ Buyurtma berish", callback_data: "Bot_buyurtma" }],
              [{ text: "ğŸ”™ Ortga", callback_data: "start_menu" }],
            ],
          },
        },
      );
      break;

    case "admin":
      bot.sendMessage(
        chatId,
        "<b>Admin bilan bogâ€˜lanish:</b>\n@KXNexsus\n\n<i>Bot haqida fikr-mulohaza:</i>\n@M_Kimyonazarov",
        {
          parse_mode: "HTML",
          reply_markup: {
            inline_keyboard: [
              [{ text: "ğŸ”™ Ortga", callback_data: "start_menu" }],
            ],
          },
        },
      );
      break;

    case "buyum":
      bot.sendMessage(
        chatId,
        "ğŸ§¤ <b>Innovatsion buyum:</b>\nğŸ™ Soqovlar uchun imo-ni nutqqa aylantiruvchi qoâ€˜lqop\n\nğŸ“½ <a href='https://drive.google.com/file/d/1-5uau7c7YabLrJ9Beo5cO1-QNb6jmskt/view?usp=drivesdk'>Video bilan tanishing</a>",
        {
          parse_mode: "HTML",
          disable_web_page_preview: true,
          reply_markup: {
            inline_keyboard: [
              [{ text: "ğŸ”™ Ortga", callback_data: "start_menu" }],
            ],
          },
        },
      );
      break;

    default:
      bot.sendMessage(chatId, "âš ï¸ Noma'lum buyruq.", {
        reply_markup: {
          inline_keyboard: [
            [{ text: "ğŸ”™ Ortga", callback_data: "start_menu" }],
          ],
        },
      });
  }
});

bot.on("message", (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;
  if (text.startsWith("/")) return;
  if (!userState[chatId]) return;

  const state = userState[chatId];

  switch (state.step) {
    case 1:
      state.name = text;
      state.step = 2;
      bot.sendMessage(chatId, "ğŸ“ Telefon raqamingizni kiriting:");
      break;
    case 2:
      state.phone = text;
      state.step = 3;
      bot.sendMessage(
        chatId,
        "ğŸ“ Qoâ€˜shimcha izohingiz boâ€˜lsa yozing (yoâ€˜q boâ€˜lsa, 'Yoâ€˜q' deb yozing):",
      );
      break;
    case 3:
      state.comment = text;
      const user = msg.from;
      let service =
        {
          order_0dan: "0 dan sayt",
          order_clone: "Template dan sayt",
          order_update: "Sayt yangilash",
          Domain_buyurtma: "Domen & Hosting",
          Bot_buyurtma: "Bot xizmatlari",
        }[state.serviceType] || "Umumiy";
      const summary = `
ğŸ“¥ *Yangi Buyurtma:*
ğŸ‘¤ Buyurtmachi: ${user.first_name || "Nomaâ€™lum"}
ğŸ”— Username: ${user.username ? "@" + user.username : "Yoâ€˜q"}
ğŸ†” ID: ${user.id}
ğŸ‘¨â€ğŸ’¼ Ismi: ${state.name}
ğŸ“ Tel: ${state.phone}
ğŸ›  Xizmat: ${service}
ğŸ“ Izoh: ${state.comment}`;

      bot.sendMessage(
        chatId,
        "âœ… Buyurtmangiz qabul qilindi! Tez orada bogâ€˜lanamiz.",
      );
      bot.sendMessage(adminChatId, escapeMarkdown(summary), {
        parse_mode: "Markdown",
      });
      delete userState[chatId];
      break;
  }
});

const app = express();
app.get("/", (req, res) => {
  res.send("ğŸ¤– Bot ishlayapti!");
});
app.listen(3000, () => {
  console.log("âœ… Express server ishga tushdi. Port: 3000");
});
